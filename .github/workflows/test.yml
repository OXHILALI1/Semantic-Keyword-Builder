name: Automated Tests

on:
  push:
    branches: [ main, develop, development-* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, "3.10", "3.11"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install pytest if available, otherwise fall back to unittest
        pip install pytest pytest-cov || echo "pytest not available, using unittest"
        # Install other dependencies if they exist
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Check code structure
      run: |
        echo "Checking for required files..."
        test -f "new_workflow_analyzer.py" || { echo "Missing new_workflow_analyzer.py"; exit 1; }
        test -f "auto_add_workflow.py" || { echo "Missing auto_add_workflow.py"; exit 1; }
        test -d "tests" || { echo "Missing tests directory"; exit 1; }
        echo "Code structure check passed"

    - name: Run dependency check
      run: |
        python run_tests.py --check-deps

    - name: Run quick validation
      run: |
        python run_tests.py --quick

    - name: Run unit tests
      run: |
        python run_tests.py --unit

    - name: Run integration tests
      run: |
        python run_tests.py --integration

    - name: Run end-to-end tests
      run: |
        python run_tests.py --e2e

    - name: Run complete test suite
      run: |
        python run_tests.py

    - name: Check workflow samples
      run: |
        echo "Checking workflow directory structure..."
        if [ -d "workflows" ]; then
          workflow_count=$(find workflows -name "*.json" | wc -l)
          echo "Found $workflow_count workflow files"
          if [ $workflow_count -gt 0 ]; then
            echo "Sample workflow files found - repository looks healthy"
          else
            echo "Warning: No workflow files found, but this might be expected for a new repository"
          fi
        else
          echo "No workflows directory found - this might be expected for testing branches"
        fi

  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Check Python syntax
      run: |
        python -m py_compile new_workflow_analyzer.py
        python -m py_compile auto_add_workflow.py
        python -m py_compile run_tests.py
        echo "Python syntax check passed"

    - name: Check JSON structure in test files
      run: |
        echo "Checking JSON syntax in test files..."
        find tests -name "*.py" -exec python -c "
        import ast
        import sys
        try:
            with open(sys.argv[1], 'r') as f:
                ast.parse(f.read())
            print(f'✓ {sys.argv[1]}')
        except SyntaxError as e:
            print(f'✗ {sys.argv[1]}: {e}')
            sys.exit(1)
        " {} \;

    - name: Validate repository structure
      run: |
        echo "Validating repository structure..."
        
        # Check required files
        required_files=(
          "README.md"
          "CLAUDE.md"
          "new_workflow_analyzer.py"
          "auto_add_workflow.py"
          "run_tests.py"
          "pytest.ini"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "✓ $file"
          else
            echo "✗ Missing: $file"
            exit 1
          fi
        done
        
        # Check directory structure
        required_dirs=("tests" "tests/unit" "tests/integration" "tests/e2e")
        for dir in "${required_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "✓ $dir/"
          else
            echo "✗ Missing directory: $dir/"
            exit 1
          fi
        done
        
        echo "Repository structure validation passed"

  test-on-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest || echo "pytest not available, using unittest"

    - name: Run quick validation on Windows
      run: |
        python run_tests.py --quick

    - name: Test Windows-specific functionality
      run: |
        python run_tests.py --unit

  test-on-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest || echo "pytest not available, using unittest"

    - name: Run quick validation on macOS
      run: |
        python run_tests.py --quick

    - name: Test macOS-specific functionality
      run: |
        python run_tests.py --unit